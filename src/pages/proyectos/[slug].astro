---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';
import ProjectGallery from '../../components/ProjectGallery.astro';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

// Cargar todas las imágenes de la carpeta de assets/projects-sources
// import.meta.glob debe ser literal, no puede usar variables dinámicas en la cadena
const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/assets/projects-sources/**/*.{jpeg,jpg,png,gif,webp,JPEG,JPG,PNG,GIF,WEBP}', { eager: true });

// Filtrar las imágenes que pertenecen a este proyecto específico
// Asumimos que la estructura es src/assets/projects-sources/[slug]/imagen.jpg
const projectImages = Object.keys(allImages)
  .filter(path => path.includes(`/${project.id}/`))
  .map(path => allImages[path].default);

// Formatear fecha
const formattedDate = project.data.date ? new Date(project.data.date).toLocaleDateString('es-MX', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) : null;
---

<Layout title={`${project.data.title} | Alejandro Gracia`}>
  <article>
    <!-- Hero Section -->
    <div class="relative h-[60vh] min-h-[400px] w-full overflow-hidden">
      {project.data.cover && (
        <Image 
          src={project.data.cover} 
          alt={project.data.coverAlt || project.data.title}
          class="absolute inset-0 w-full h-full object-cover"
          transition:name={`project-image-${project.id}`}
        />
      )}
      <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>
      
      <div class="absolute bottom-0 left-0 w-full p-8 md:p-16">
        <div class="max-w-4xl mx-auto">
          <div class="flex gap-4 mb-6">
            <a href="/" class="inline-flex items-center text-white/80 hover:text-white transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
              </svg>
              Inicio
            </a>
            <span class="text-white/50">/</span>
            <a href="/proyectos" class="inline-flex items-center text-white/80 hover:text-white transition">
              Proyectos
            </a>
          </div>
          
          <div class="flex flex-wrap gap-4 mb-4">
            {project.data.tags?.map(tag => (
              <span class="px-3 py-1 bg-blue-600/90 text-white text-xs font-bold uppercase tracking-wider rounded-full">
                {tag}
              </span>
            ))}
          </div>
          
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4 leading-tight">
            {project.data.title}
          </h1>
          
          <div class="flex flex-wrap items-center gap-6 text-slate-300 text-sm md:text-base">
            {project.data.client && (
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <span class="font-semibold text-white mr-1">Cliente:</span> {project.data.client}
              </div>
            )}
            
            {formattedDate && (
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                {formattedDate}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Content Section -->
    <div class="max-w-4xl mx-auto px-4 py-16 md:py-24">
      <div class="prose prose-lg prose-slate max-w-none prose-headings:font-bold prose-headings:text-slate-900 prose-p:text-slate-600 prose-a:text-blue-600 hover:prose-a:text-blue-500">
        <Content />
      </div>

      <!-- Gallery Section -->
      <ProjectGallery images={projectImages} />
    </div>
  </article>
</Layout>
